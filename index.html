<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Popipi Kids - Studio Pro</title>
    <style>
        :root { --bg-app: #6a3093; --side-panel: rgba(0, 0, 0, 0.4); --active: #ffff00; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg-app); font-family: 'Arial', sans-serif; -webkit-touch-callout: none; user-select: none; touch-action: none; }
        
        #orientacao-aviso { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #4e2170; z-index: 9999; color: white; text-align: center; flex-direction: column; justify-content: center; align-items: center; }
        @media (orientation: portrait) { #orientacao-aviso { display: flex; } }

        .logo-flutuante { position: absolute; top: 10px; left: 10px; z-index: 100; pointer-events: none; }
        .logo-flutuante img { width: 100px; }

        .app-container { display: flex; width: 100vw; height: 100vh; }
        .sidebar { width: 130px; background: var(--side-panel); display: flex; flex-direction: column; align-items: center; padding-top: 70px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        
        .btn { width: 50px; height: 50px; border-radius: 12px; border: none; background: white; font-size: 22px; cursor: pointer; box-shadow: 0 4px 0 #bbb; }
        .btn.active { background: var(--active); box-shadow: 0 4px 0 #b3b300; }

        .c-btn { width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; cursor: pointer; }
        .c-btn.active { border-color: var(--active); transform: scale(1.1); }

        .main-content { flex-grow: 1; display: flex; justify-content: center; align-items: center; padding: 10px; }
        canvas { background: white; border-radius: 8px; max-width: 95%; max-height: 95%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        .sidebar-right { width: 120px; border-left: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        .thumb { width: 80px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; border: 3px solid transparent; background: white; }
        .thumb.active { border-color: var(--active); }
    </style>
</head>
<body>

<div id="orientacao-aviso"><h2>Gire o celular! üîÑ</h2></div>
<div class="logo-flutuante"><img src="logo.png"></div>

<div class="app-container">
    <div class="sidebar">
        <div class="grid">
            <button class="btn active" id="brushBtn" onclick="setTool('brush')">‚úèÔ∏è</button>
            <button class="btn" id="fillBtn" onclick="setTool('fill')">ü™£</button>
            <button class="btn" id="eraserBtn" onclick="setTool('eraser')">üßΩ</button>
            <button class="btn" style="background:#ff4757" onclick="clearCanvas()">üóëÔ∏è</button>
        </div>
        <div class="grid" id="colorGrid">
            <div class="c-btn active" style="background: #FFD700;" onclick="selectColor('#FFD700', this)"></div>
            <div class="c-btn" style="background: #FF0000;" onclick="selectColor('#FF0000', this)"></div>
            <div class="c-btn" style="background: #FF1493;" onclick="selectColor('#FF1493', this)"></div>
            <div class="c-btn" style="background: #00BFFF;" onclick="selectColor('#00BFFF', this)"></div>
            <div class="c-btn" style="background: #32CD32;" onclick="selectColor('#32CD32', this)"></div>
            <div class="c-btn" style="background: #1a1a1a;" onclick="selectColor('#1a1a1a', this)"></div>
            <div class="c-btn" style="background: #8B4513;" onclick="selectColor('#8B4513', this)"></div>
            <div class="c-btn" style="background: #FF8C00;" onclick="selectColor('#FF8C00', this)"></div>
        </div>
    </div>

    <div class="main-content">
        <canvas id="paintCanvas"></canvas>
    </div>

    <div class="sidebar sidebar-right">
        <img src="1.png" class="thumb active" onclick="changeImage('1.png', this)">
        <img src="2.png" class="thumb" onclick="changeImage('2.png', this)">
        <img src="3.png" class="thumb" onclick="changeImage('3.png', this)">
        <img src="4.png" class="thumb" onclick="changeImage('4.png', this)">
        <img src="5.png" class="thumb" onclick="changeImage('5.png', this)">
        <img src="6.png" class="thumb" onclick="changeImage('6.png', this)">
    </div>
</div>

<script>
    const canvas = document.getElementById('paintCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let currentImg = new Image();
    let currentColor = '#FFD700';
    let tool = 'brush';
    let painting = false;

    // SOLU√á√ÉO DEFINITIVA PARA O BALDE: Carrega a imagem sem travas de seguran√ßa
    function loadImage(src) {
        const tempImg = new Image();
        tempImg.crossOrigin = "anonymous";
        tempImg.src = src + "?t=" + new Date().getTime();
        
        tempImg.onload = () => {
            canvas.width = tempImg.width;
            canvas.height = tempImg.height;
            // Desenha no canvas e salva como refer√™ncia
            ctx.drawImage(tempImg, 0, 0);
            currentImg.src = canvas.toDataURL(); // Converte para local!
            currentImg.onload = () => {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                drawBase();
            };
        };
    }

    function drawBase() {
        ctx.save();
        ctx.globalCompositeOperation = 'multiply';
        ctx.drawImage(currentImg, 0, 0);
        ctx.restore();
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const ev = e.touches ? e.touches[0] : e;
        return {
            x: Math.floor((ev.clientX - rect.left) * (canvas.width / rect.width)),
            y: Math.floor((ev.clientY - rect.top) * (canvas.height / rect.height))
        };
    }

    function start(e) {
        const p = getPos(e);
        if(tool === 'fill') {
            fill(p.x, p.y);
        } else {
            painting = true;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
        }
    }

    function move(e) {
        if(!painting || tool === 'fill') return;
        const p = getPos(e);
        ctx.save();
        ctx.globalCompositeOperation = (tool === 'eraser') ? 'destination-out' : 'source-over';
        ctx.lineWidth = (tool === 'eraser') ? 40 : 15;
        ctx.strokeStyle = currentColor;
        ctx.lineCap = 'round';
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        ctx.restore();
        drawBase();
    }

    function fill(startX, startY) {
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const pixels = imgData.data;
        const startPos = (startY * canvas.width + startX) * 4;
        
        const targetR = pixels[startPos], targetG = pixels[startPos+1], targetB = pixels[startPos+2];
        const fillR = parseInt(currentColor.slice(1,3),16), fillG = parseInt(currentColor.slice(3,5),16), fillB = parseInt(currentColor.slice(5,7),16);

        if (targetR < 50 && targetG < 50 && targetB < 50) return; // N√£o pinta o preto
        if (targetR === fillR && targetG === fillG && targetB === fillB) return;

        const stack = [[startX, startY]];
        while(stack.length) {
            const [x, y] = stack.pop();
            const p = (y * canvas.width + x) * 4;
            if(pixels[p] === targetR && pixels[p+1] === targetG && pixels[p+2] === targetB) {
                pixels[p] = fillR; pixels[p+1] = fillG; pixels[p+2] = fillB; pixels[p+3] = 255;
                if(x>0) stack.push([x-1, y]);
                if(x<canvas.width-1) stack.push([x+1, y]);
                if(y>0) stack.push([startX, y-1]); // Corre√ß√£o de performance aqui
                if(y<canvas.height-1) stack.push([x, y+1]);
            }
        }
        ctx.putImageData(imgData, 0, 0);
        drawBase();
    }

    canvas.onmousedown = start;
    canvas.onmousemove = move;
    window.onmouseup = () => painting = false;
    canvas.ontouchstart = (e) => { e.preventDefault(); start(e); };
    canvas.ontouchmove = (e) => { e.preventDefault(); move(e); };
    canvas.ontouchend = () => painting = false;

    function selectColor(c, el) { currentColor = c; document.querySelectorAll('.c-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active'); }
    function setTool(t) { tool = t; document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active')); document.getElementById(t+'Btn').classList.add('active'); }
    function clearCanvas() { if(confirm("Limpar?")) { ctx.clearRect(0,0,canvas.width,canvas.height); drawBase(); } }
    function changeImage(s, el) { loadImage(s); document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active')); el.classList.add('active'); }

    window.onload = () => loadImage('1.png');
</script>
</body>
</html>
