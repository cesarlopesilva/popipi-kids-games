<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Popipi Kids - Studio Pro 2</title>
    <style>
        :root {
            --bg-app: #6a3093; 
            --side-panel: rgba(0, 0, 0, 0.4);
            --active: #ffff00;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; 
            /* svh resolve o problema do Safari cortar o fundo */
            height: 100vh; height: 100svh; 
            overflow: hidden;
            background: var(--bg-app);
            font-family: 'Arial', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

        #orientation-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-app);
            z-index: 9999;
            color: white;
            text-align: center;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .phone-icon {
            width: 50px; height: 90px;
            border: 4px solid white; border-radius: 10px;
            margin-bottom: 20px;
            animation: rotatePhone 2s infinite ease-in-out;
        }

        @keyframes rotatePhone {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
            100% { transform: rotate(90deg); }
        }

        .logo-flutuante {
            position: absolute; top: 10px; left: 10px;
            z-index: 100; pointer-events: none;
        }
        .logo-flutuante img { width: 80px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3)); }

        .app-container { display: flex; width: 100vw; height: 100%; }

        .sidebar {
            width: 130px; background: var(--side-panel);
            display: flex; flex-direction: column; align-items: center;
            padding: 10px 5px; 
            padding-top: 60px; /* Reduzido para caber mais coisas */
            overflow-y: auto; flex-shrink: 0;
            /* Padding extra no fundo para o Safari n√£o bloquear as √∫ltimas cores */
            padding-bottom: 80px; 
            -webkit-overflow-scrolling: touch;
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .label { color: white; font-size: 9px; font-weight: bold; margin: 8px 0 4px; text-transform: uppercase; }

        .btn {
            width: 45px; height: 45px; border-radius: 10px; border: none; background: white;
            font-size: 20px; cursor: pointer; box-shadow: 0 4px 0 #bbb;
            display: flex; align-items: center; justify-content: center;
        }
        .btn.active { background: var(--active); box-shadow: 0 4px 0 #b3b300; transform: translateY(2px); }

        .c-btn { width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; cursor: pointer; }
        .c-btn.active { border-color: var(--active); transform: scale(1.1); box-shadow: 0 0 10px var(--active); }

        .main-content {
            flex-grow: 1; display: flex; justify-content: center; align-items: center;
            padding: 5px; position: relative; overflow: hidden;
        }

        #viewport { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }

        canvas {
            background: white; border-radius: 5px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 98%; max-height: 98%;
            /* Melhora a performance de renderiza√ß√£o no Safari */
            image-rendering: -webkit-optimize-contrast; 
        }

        .sidebar-right { width: 110px; border-left: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        .thumb { width: 80px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; background: white; border: 3px solid transparent; }
        .thumb.active { border-color: var(--active); }

        .save-btn-large { grid-column: span 2; width: 100%; background: #2ed573 !important; color: white; font-size: 10px !important; box-shadow: 0 4px 0 #1e9651 !important; }

        @media screen and (orientation: portrait) { #orientation-overlay { display: flex; } }
        ::-webkit-scrollbar { width: 0; }
    </style>
</head>
<body>

<div id="orientation-overlay">
    <div class="phone-icon"></div>
    <h2>Gire o celular!</h2>
    <p>Para usar o Studio Popipi Kids, use o aparelho deitado.</p>
</div>

<div class="logo-flutuante"><img src="logo.png"></div>

<div class="app-container">
    <div class="sidebar">
        <div class="label">A√ß√µes</div>
        <div class="grid">
            <button class="btn active" id="brushBtn" onclick="setTool('brush')">‚úèÔ∏è</button>
            <button class="btn" id="fillBtn" onclick="setTool('fill')">ü™£</button>
            <button class="btn" id="eraserBtn" onclick="setTool('eraser')">üßΩ</button>
            <button class="btn" style="background:#ff4757; color:white;" onclick="clearCanvas()">üóëÔ∏è</button>
            <button class="btn save-btn-large" onclick="saveImage()">SALVAR üíæ</button>
        </div>
        <div class="label">Cores</div>
        <div class="grid" id="colorGrid">
            <div class="c-btn active" style="background: #FFD700;" onclick="selectColor('#FFD700', this)"></div>
            <div class="c-btn" style="background: #FF8C00;" onclick="selectColor('#FF8C00', this)"></div>
            <div class="c-btn" style="background: #FF0000;" onclick="selectColor('#FF0000', this)"></div>
            <div class="c-btn" style="background: #FF1493;" onclick="selectColor('#FF1493', this)"></div>
            <div class="c-btn" style="background: #9400D3;" onclick="selectColor('#9400D3', this)"></div>
            <div class="c-btn" style="background: #00BFFF;" onclick="selectColor('#00BFFF', this)"></div>
            <div class="c-btn" style="background: #32CD32;" onclick="selectColor('#32CD32', this)"></div>
            <div class="c-btn" style="background: #1a1a1a;" onclick="selectColor('#1a1a1a', this)"></div>
            <div class="c-btn" style="background: #00008B;" onclick="selectColor('#00008B', this)"></div>
            <div class="c-btn" style="background: #fcfcfc;" onclick="selectColor('#fcfcfc', this)"></div>
            <div class="c-btn" style="background: #8B4513;" onclick="selectColor('#8B4513', this)"></div>
            <div class="c-btn" style="background: #008080;" onclick="selectColor('#008080', this)"></div>
        </div>
    </div>

    <div class="main-content">
        <div id="viewport">
            <canvas id="paintCanvas"></canvas>
        </div>
    </div>

    <div class="sidebar sidebar-right">
        <div class="label">Desenhos</div>
        <img src="1.png" class="thumb active" onclick="changeImage('1.png', this)">
        <img src="2.png" class="thumb" onclick="changeImage('2.png', this)">
        <img src="3.png" class="thumb" onclick="changeImage('3.png', this)">
        <img src="4.png" class="thumb" onclick="changeImage('4.png', this)">
        <img src="5.png" class="thumb" onclick="changeImage('5.png', this)">
        <img src="6.png" class="thumb" onclick="changeImage('6.png', this)">
    </div>
</div>

<script>
    const canvas = document.getElementById('paintCanvas');
    const ctx = canvas.getContext('2d', { alpha: false, willReadFrequently: true });
    const viewport = document.getElementById('viewport');
    
    let currentImg = new Image();
    let currentColor = '#FFD700';
    let tool = 'brush';
    let painting = false;
    let needsRedraw = false;

    // ZOOM E PAN
    let scale = 1, translateX = 0, translateY = 0, initialPinchDistance = null, isZooming = false;

    function updateTransform() {
        canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }

    function resizeCanvasToFit() {
        if (!currentImg.complete) return;
        canvas.width = currentImg.width;
        canvas.height = currentImg.height;
        scale = 1; translateX = 0; translateY = 0;
        updateTransform();
        drawBase();
    }

    function loadImage(src) {
        currentImg = new Image();
        currentImg.crossOrigin = "anonymous";
        currentImg.src = src + "?v=" + Date.now(); // Cache busting para Safari
        currentImg.onload = () => resizeCanvasToFit();
    }

    function drawBase() {
        ctx.save();
        ctx.globalCompositeOperation = 'multiply';
        ctx.drawImage(currentImg, 0, 0);
        ctx.restore();
    }

    // Otimiza√ß√£o de renderiza√ß√£o para Safari
    function render() {
        if (needsRedraw) {
            drawBase();
            needsRedraw = false;
        }
        requestAnimationFrame(render);
    }
    requestAnimationFrame(render);

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const x = (clientX - rect.left) * (canvas.width / rect.width);
        const y = (clientY - rect.top) * (canvas.height / rect.height);
        return { x, y };
    }

    // EVENTOS TOUCH OTIMIZADOS
    viewport.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            isZooming = true; painting = false;
            initialPinchDistance = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        } else if (e.touches.length === 1 && !isZooming) {
            start(e);
        }
    }, { passive: false });

    viewport.addEventListener('touchmove', (e) => {
        e.preventDefault(); 
        if (e.touches.length === 2 && isZooming) {
            const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            if (initialPinchDistance) {
                const delta = dist / initialPinchDistance;
                scale = Math.min(Math.max(scale * delta, 1), 5);
                initialPinchDistance = dist;
                updateTransform();
            }
        } else if (e.touches.length === 1 && painting) {
            move(e);
        }
    }, { passive: false });

    viewport.addEventListener('touchend', () => { isZooming = false; painting = false; });

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', move);
    window.addEventListener('mouseup', () => painting = false);

    function start(e) {
        if (isZooming) return;
        const pos = getPos(e);
        if (tool === 'fill') {
            const r = parseInt(currentColor.slice(1,3),16), g = parseInt(currentColor.slice(3,5),16), b = parseInt(currentColor.slice(5,7),16);
            floodFill(Math.round(pos.x), Math.round(pos.y), [r, g, b]);
        } else {
            painting = true;
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }
    }

    function move(e) {
        if (!painting || isZooming) return;
        const pos = getPos(e);
        ctx.save();
        ctx.globalCompositeOperation = (tool === 'eraser') ? 'destination-out' : 'source-over';
        ctx.lineWidth = (tool === 'eraser') ? 60 : 25;
        ctx.strokeStyle = currentColor;
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        ctx.restore();
        needsRedraw = true; // Agenda o redesenho do multiply
    }

    function floodFill(startX, startY, fillRGB) {
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imgData.data;
        const pos = (startY * canvas.width + startX) * 4;
        const targetR = data[pos], targetG = data[pos+1], targetB = data[pos+2];
        
        if (targetR < 50 && targetG < 50 && targetB < 50) return;
        if (targetR === fillRGB[0] && targetG === fillRGB[1] && targetB === fillRGB[2]) return;

        const stack = [[startX, startY]];
        while (stack.length > 0) {
            const [x, y] = stack.pop();
            const p = (y * canvas.width + x) * 4;
            if (data[p] === targetR && data[p+1] === targetG && data[p+2] === targetB) {
                data[p] = fillRGB[0]; data[p+1] = fillRGB[1]; data[p+2] = fillRGB[2]; data[p+3] = 255;
                if (x + 1 < canvas.width) stack.push([x + 1, y]);
                if (x - 1 >= 0) stack.push([x - 1, y]);
                if (y + 1 < canvas.height) stack.push([x, y + 1]);
                if (y - 1 >= 0) stack.push([x, y - 1]);
            }
        }
        ctx.putImageData(imgData, 0, 0);
        drawBase();
    }

    function selectColor(color, el) {
        currentColor = (color === '#000000') ? '#1a1a1a' : color;
        document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        if(tool === 'eraser') setTool('brush');
    }

    function setTool(t) {
        tool = t;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        document.getElementById(t + 'Btn')?.classList.add('active');
    }

    function clearCanvas() { if (confirm("Apagar tudo?")) { ctx.clearRect(0, 0, canvas.width, canvas.height); drawBase(); } }
    
    function changeImage(src, el) {
        document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        loadImage(src);
    }

    function saveImage() {
        const link = document.createElement('a');
        link.download = 'desenho-popipi.png';
        link.href = canvas.toDataURL("image/png");
        link.click();
    }

    window.onload = () => loadImage('1.png');
</script>
</body>
</html>
